# Руководство по деплою и сохранности данных

Это практичная пошаговая инструкция по развёртыванию приложения (Frontend + Backend + SQLite) и защите данных от потери при обновлениях.

## Что входит в систему

- Frontend: React + Vite (статический билд `frontend/dist`)
- Backend: Node.js + Express (порт по умолчанию 5000)
- База данных: SQLite (один `.sqlite` файл)
- Файлы пользователей: директория `uploads` (аватары и т. п.)

## Цель

- Разворачивать приложение безопасно и повторяемо
- Не терять данные (базу и загрузки) при обновлениях кода

---

## Архитектура папок (рекомендация для продакшена на Windows)

- `C:\ProjectX\app` — папка с кодом (деплоим сюда)
- `C:\ProjectX\data` — папка с данными (постоянное хранилище)
  - `C:\ProjectX\data\database.sqlite` — база SQLite
  - `C:\ProjectX\data\uploads\` — пользовательские загрузки

Данные живут отдельно от кода. При деплое заменяем только `app`, а `data` не трогаем.

---

## Переменные окружения (backend/.env)

Создайте файл `C:\ProjectX\app\backend\.env` со значениями:

```
PORT=5000
NODE_ENV=production
JWT_SECRET=установите_сильный_секрет
SQLITE_DB_PATH=C:\ProjectX\data\database.sqlite
```

- `SQLITE_DB_PATH` указывает на файл БД вне кода.
- CORS: домены фронтенда можно добавить в `backend/server.js` (список `origin`).

---

## Файлы загрузок (uploads)

По умолчанию бэкенд отдаёт `/uploads` из папки `backend/uploads`. Для сохранности:

Варианты:
1) Хранить загрузки в `C:\ProjectX\data\uploads` и сделать симлинк в `backend/uploads`.
2) Либо изменить код раздачи статики, чтобы он указывал на `C:\ProjectX\data\uploads` (требуется правка `server.js`).
3) Либо никогда не удалять `backend/uploads` при деплое (менее надёжно).

Рекомендован 1-й или 2-й вариант.

---

## Сборка и запуск (первый запуск)

### Frontend
1) Установить зависимости:
   - Зайти в `frontend/` и выполнить `npm install`
2) Собрать проект:
   - `npm run build` — будет создан `frontend/dist`
3) Отдавать `dist/` любым веб-сервером или статическим хостингом (IIS/Nginx/Caddy/Netlify и т. п.)

### Backend
1) Установить зависимости в `backend/`: `npm install`
2) Убедиться, что задан `.env` (см. выше)
3) Применить схемы и пересчёты (безопасно повторять):
   - `node scripts/ensurePointsSchema.js` — гарантирует нужные колонки
   - `node recalculate-all.js` — пересчёт очков по новым правилам
4) Запустить сервер: `node server.js`
   - Health-check: `GET /api/health`

По умолчанию сервер слушает `127.0.0.1:5000` — удобно, если будет обратный прокси. Для прямого внешнего доступа можно сменить хост на `0.0.0.0`.

---

## Запуск как сервис (чтобы всегда работал)

Выберите один способ:

### Вариант A: PM2 (c PM2 Windows Service)
- Установите Node.js LTS
- `npm install -g pm2`
- Установите и запустите PM2 как Windows-сервис (pm2-windows-service)
- Запустите приложение: `pm2 start C:\ProjectX\app\backend\server.js --name projectx`
- Сохраните конфиг: `pm2 save`
- Перезапуск без простоя: `pm2 reload projectx`

### Вариант B: NSSM (Non-Sucking Service Manager)
- Оберните `node backend/server.js` как Windows-службу
- AppDirectory: `C:\ProjectX\app\backend`
- Укажите переменные окружения для службы (`NODE_ENV`, `SQLITE_DB_PATH`, `JWT_SECRET`)

### Вариант C: Планировщик задач
- Запуск при старте системы и перезапуск при сбое (просто, но менее удобно)

---

## Reverse proxy и HTTPS

Рекомендуется вынести HTTPS и домены на веб-сервер и проксировать на Node:

- Caddy — самый простой автосертификаты
- Nginx/IIS — классика (настроить server/site, proxy_pass на `127.0.0.1:5000`)
- Обновите CORS-список в `server.js`, добавив домен фронтенда

---

## Обновления без потери данных

Защищаем два ресурса:
- `C:\ProjectX\data\database.sqlite`
- `C:\ProjectX\data\uploads\`

Правило: не затирайте папку `data` при деплое. Обновляется только `app`.

Чеклист обновления:
1) Бэкап БД и загрузок (см. ниже)
2) Остановить сервис (или `pm2 reload` для минимального простоя)
3) Обновить код в `C:\ProjectX\app` (не трогая `C:\ProjectX\data`)
4) `npm install` в `backend/`
5) `node scripts/ensurePointsSchema.js`
6) (опционально) `node recalculate-all.js`
7) Запустить/перезагрузить сервис
8) Проверить `GET /api/health` и фронтенд

---

## Резервное копирование SQLite без повреждений

SQLite лучше бэкапить через встроенный механизм `.backup`:
- Установите консольный `sqlite3`
- По расписанию запускайте резервное копирование:

```
sqlite3 C:\ProjectX\data\database.sqlite ".backup 'C:\ProjectX\backups\database-YYYYMMDD.sqlite'"
```

Если копируете файл напрямую — остановите сервис на время копирования или включите WAL-режим (см. ниже).

### WAL-режим (опционально)

- Улучшает параллелизм и упрощает резервное копирование
- Включить можно однократно командой PRAGMA после открытия БД: `PRAGMA journal_mode=WAL;`

### Бэкап загрузок

- Периодически архивируйте `C:\ProjectX\data\uploads\`
- Храните несколько последних архивов (7–30 дней)

---

## Сборка фронтенда и публикация

- `npm run build` в `frontend/` создаёт `dist/`
- Публикуйте `dist/`:
  - локально через Nginx/IIS/Caddy
  - или через статический хостинг (Netlify/Cloudflare Pages)
- Настройте API-базовый URL фронтенда на ваш домен бэкенда
- Добавьте домен фронтенда в CORS на бэкенде

---

## Мини-чеклист перед продакшеном

- [ ] `JWT_SECRET` установлен и хранится вне GIT
- [ ] `SQLITE_DB_PATH` указывает на `C:\ProjectX\data\database.sqlite`
- [ ] `uploads` вынесены в постоянное хранилище или не удаляются при деплое
- [ ] Настроен HTTPS (через Caddy/Nginx/IIS) и CORS
- [ ] Сервис автоматически стартует и перезапускается
- [ ] Настроено резервное копирование БД и загрузок по расписанию
- [ ] Проверен `/api/health` и ключевые страницы фронтенда

---

## Быстрый старт (сводка команд)

Frontend:
```
cd frontend
npm install
npm run build
```

Backend:
```
cd backend
npm install
node scripts/ensurePointsSchema.js
node recalculate-all.js
node server.js
```

PM2 (если используете):
```
pm2 start C:\ProjectX\app\backend\server.js --name projectx
pm2 save
pm2 reload projectx
```

> Примечание: команды приведены для справки. В продакшене используйте службы/скрипты, соответствующие вашей инфраструктуре.

---

## Типичные проблемы и решения

- Порт 5000 занят — остановите другой процесс Node или смените порт в `.env`
- CORS ошибки — добавьте домен фронтенда в список `origin` в `server.js`
- Не грузятся аватары — проверьте, что `uploads` доступны и путь к ним не изменился
- Очки с десятичными — API округляет до целых (Math.floor), проверьте, что фронтенд не форматирует иначе

---

## Приложение может само отдавать фронтенд (опционально)

Если хотите, чтобы Express отдавал `frontend/dist`:
- Скопируйте `dist/` в папку, до которой есть доступ у бэкенда (например, `C:\ProjectX\app\frontend\dist`)
- Добавьте в `server.js` статическую раздачу `dist` и catch-all маршрут на `index.html`
- Это удобно для одноузлового развёртывания без отдельного веб-сервера

---

Готово! При такой схеме код обновляется без риска потерять БД и пользовательские файлы, а сервис остаётся стабильным и перезапускается автоматически.