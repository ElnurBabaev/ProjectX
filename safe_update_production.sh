#!/bin/bash

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ProjectX —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bash safe_update_production.sh

set -e

echo "üöÄ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ProjectX –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date +'%H:%M:%S')] $1${NC}"
}

warn() {
    echo -e "${YELLOW}[$(date +'%H:%M:%S')] $1${NC}"
}

error() {
    echo -e "${RED}[$(date +'%H:%M:%S')] $1${NC}"
}

info() {
    echo -e "${BLUE}[$(date +'%H:%M:%S')] $1${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
restore_backup() {
    error "‚ùå –û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è! –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
    
    if [ -f "/opt/projectx/backup/database_backup_$(date +%Y%m%d).sqlite" ]; then
        cp "/opt/projectx/backup/database_backup_$(date +%Y%m%d).sqlite" "/opt/projectx/backend/database.sqlite"
        log "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"
    fi
    
    if [ -d "/opt/projectx/backup/backend_backup_$(date +%Y%m%d)" ]; then
        rm -rf /opt/projectx/backend
        cp -r "/opt/projectx/backup/backend_backup_$(date +%Y%m%d)" /opt/projectx/backend
        log "‚úÖ Backend –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"
    fi
    
    if [ -d "/opt/projectx/backup/frontend_backup_$(date +%Y%m%d)" ]; then
        rm -rf /opt/projectx/frontend
        cp -r "/opt/projectx/backup/frontend_backup_$(date +%Y%m%d)" /opt/projectx/frontend
        log "‚úÖ Frontend –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"
    fi
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
    pm2 restart projectx-api 2>/dev/null || true
    systemctl reload nginx 2>/dev/null || true
    
    error "üí• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ."
    exit 1
}

# –õ–æ–≤–∏–º –æ—à–∏–±–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
trap restore_backup ERR

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -d "/opt/projectx" ]; then
    error "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /opt/projectx –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    exit 1
fi

info "üîç –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
if [ "$EUID" -ne 0 ]; then
    error "‚ùå –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ (–º–∏–Ω–∏–º—É–º 1GB)
AVAILABLE_SPACE=$(df /opt/projectx --output=avail | tail -1)
if [ "$AVAILABLE_SPACE" -lt 1048576 ]; then  # 1GB –≤ KB
    error "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ (–Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 1GB)"
    exit 1
fi

log "‚úÖ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã"

# ========================
# –°–û–ó–î–ê–ù–ò–ï –†–ï–ó–ï–†–í–ù–´–• –ö–û–ü–ò–ô
# ========================

BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/opt/projectx/backup"

log "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π..."

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤
mkdir -p "$BACKUP_DIR"

# 1. –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQLite
log "üìÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
if [ -f "/opt/projectx/backend/database.sqlite" ]; then
    # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—É—é –∫–æ–ø–∏—é SQLite
    sqlite3 /opt/projectx/backend/database.sqlite ".backup $BACKUP_DIR/database_backup_$BACKUP_DATE.sqlite"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
    if sqlite3 "$BACKUP_DIR/database_backup_$BACKUP_DATE.sqlite" "PRAGMA integrity_check;" | grep -q "ok"; then
        log "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞: database_backup_$BACKUP_DATE.sqlite"
    else
        error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
        exit 1
    fi
else
    warn "‚ö†Ô∏è –§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ /opt/projectx/backend/database.sqlite"
fi

# 2. –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
log "‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π..."
cp -r /opt/projectx/backend "$BACKUP_DIR/backend_backup_$BACKUP_DATE"
cp -r /opt/projectx/frontend "$BACKUP_DIR/frontend_backup_$BACKUP_DATE"

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
if [ -f "/opt/projectx/backend/package.json" ]; then
    cp /opt/projectx/backend/package.json "$BACKUP_DIR/backend_package_$BACKUP_DATE.json"
fi
if [ -f "/opt/projectx/frontend/package.json" ]; then
    cp /opt/projectx/frontend/package.json "$BACKUP_DIR/frontend_package_$BACKUP_DATE.json"
fi

# 3. –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
if [ -d "/opt/projectx/backend/uploads" ]; then
    log "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
    tar -czf "$BACKUP_DIR/uploads_backup_$BACKUP_DATE.tar.gz" -C /opt/projectx/backend uploads
    log "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è uploads —Å–æ–∑–¥–∞–Ω–∞"
fi

# 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ PM2
log "üîß –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è PM2..."
pm2 save > "$BACKUP_DIR/pm2_dump_$BACKUP_DATE.txt" 2>&1 || warn "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ PM2"

log "‚úÖ –í—Å–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ–∑–¥–∞–Ω—ã –≤ $BACKUP_DIR"

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
find "$BACKUP_DIR" -name "*backup*" -type f -mtime +7 -delete 2>/dev/null || true
log "üóëÔ∏è –°—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –æ—á–∏—â–µ–Ω—ã"

# ========================
# –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–î–ê
# ========================
log "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git..."
cd /opt/projectx

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å git
log "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ git..."
if ! git status --porcelain | grep -q .; then
    log "‚úÖ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —á–∏—Å—Ç–∞—è"
else
    warn "‚ö†Ô∏è –ï—Å—Ç—å –Ω–µ–∫–æ–º–º–∏—Ç–Ω—É—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –°–æ—Ö—Ä–∞–Ω—è—é –∏—Ö..."
    git stash push -m "Auto-stash before update $BACKUP_DATE"
fi

# –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å merge —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π
log "üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π..."
if git fetch origin main; then
    log "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
else
    error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
    exit 1
fi

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
if git merge origin/main --no-edit; then
    log "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
else
    warn "‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ —Å–ª–∏—è–Ω–∏–∏. –ü—Ä–æ–±—É—é —Å rebase..."
    git merge --abort 2>/dev/null || true
    if git rebase origin/main; then
        log "‚úÖ Rebase –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    else
        error "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ï—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã"
        git rebase --abort 2>/dev/null || true
        exit 1
    fi
fi

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—ç—à –µ—Å–ª–∏ –±—ã–ª
if git stash list | grep -q "Auto-stash before update $BACKUP_DATE"; then
    log "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    if ! git stash pop; then
        warn "‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ stash. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é: git stash list"
    fi
fi

# ========================
# –û–ë–ù–û–í–õ–ï–ù–ò–ï BACKEND
# ========================
log "‚öôÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ backend..."
cd backend

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –º–µ—Å—Ç–µ
if [ -f "database.sqlite" ]; then
    log "üîí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–ø–∏—é –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º
    cp database.sqlite database.sqlite.updating
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
log "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend..."
npm install --production --no-optional

# –í—ã–ø–æ–ª–Ω—è–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è, –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö)
log "üóÑÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∞–±–ª–∏—Ü—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ —Å–æ–∑–¥–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ -f "scripts/addNotificationsTable.js" ]; then
    log "ÔøΩ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã notifications (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)..."
    node scripts/addNotificationsTable.js || warn "‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è notifications —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞"
fi

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É category –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
if [ -f "scripts/addCategoryColumn.js" ]; then
    log "üè∑Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ category (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)..."
    node scripts/addCategoryColumn.js || warn "‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è category —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
if [ -f "scripts/ensurePointsSchema.js" ]; then
    log "üí∞ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º—ã –±–∞–ª–ª–æ–≤..."
    node scripts/ensurePointsSchema.js || warn "‚ö†Ô∏è –°—Ö–µ–º–∞ –±–∞–ª–ª–æ–≤ —É–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞"
fi

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –∫–æ–ø–∏—é –µ—Å–ª–∏ –≤—Å–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
if [ -f "database.sqlite.updating" ]; then
    rm database.sqlite.updating
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–π
log "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
if sqlite3 database.sqlite "PRAGMA integrity_check;" | grep -q "ok"; then
    log "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—à–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏"
else
    error "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!"
    exit 1
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º API —Å–µ—Ä–≤–µ—Ä
log "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ API —Å–µ—Ä–≤–µ—Ä–∞..."
if pm2 describe projectx-api > /dev/null 2>&1; then
    pm2 restart projectx-api
    sleep 3
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
    if pm2 describe projectx-api | grep -q "online"; then
        log "‚úÖ API —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    else
        error "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ API —Å–µ—Ä–≤–µ—Ä–∞"
        pm2 logs projectx-api --lines 20
        exit 1
    fi
else
    log "üöÄ –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ API —Å–µ—Ä–≤–µ—Ä–∞..."
    pm2 start server.js --name projectx-api
    sleep 3
fi

cd ..

# ========================
# –û–ë–ù–û–í–õ–ï–ù–ò–ï FRONTEND
# ========================
log "üé® –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ frontend..."
cd frontend

# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ npm –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
log "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend..."
npm ci --production

# –°–±–æ—Ä–∫–∞ frontend
log "üèóÔ∏è –°–±–æ—Ä–∫–∞ frontend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
if npm run build; then
    log "‚úÖ Frontend —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ"
else
    error "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ frontend"
    exit 1
fi

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
log "üìÅ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ frontend —Ñ–∞–π–ª–æ–≤..."

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–µ–≥–æ frontend
if [ -d "/var/www/html" ] && [ "$(ls -A /var/www/html)" ]; then
    log "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ frontend..."
    mkdir -p "$BACKUP_DIR"
    tar -czf "$BACKUP_DIR/www_html_backup_$BACKUP_DATE.tar.gz" -C /var/www html
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -d "/var/www/html" ]; then
    log "üìÇ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /var/www/html..."
    mkdir -p /var/www/html
fi

# –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
    rm -rf /var/www/html/*
    cp -r dist/* /var/www/html/
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    chown -R www-data:www-data /var/www/html/
    chmod -R 755 /var/www/html/
    
    log "‚úÖ Frontend —Ñ–∞–π–ª—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã"
else
    error "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è dist –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    exit 1
fi

cd ..

# ========================
# –ü–†–û–í–ï–†–ö–ò –ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# ========================

log "üîç –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ —Å–∏—Å—Ç–µ–º—ã..."

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2
log "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ PM2..."
if pm2 list | grep -q "online"; then
    log "‚úÖ Backend –æ–±–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    error "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å backend, –ª–æ–≥–∏ PM2:"
    pm2 logs projectx-api --lines 10
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ nginx
log "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ Nginx..."
if systemctl is-active --quiet nginx; then
    log "‚úÖ Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç"
    # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
    systemctl reload nginx
else
    error "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å nginx"
    systemctl status nginx
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
log "üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API..."
API_CHECK_COUNT=0
MAX_API_CHECKS=6

while [ $API_CHECK_COUNT -lt $MAX_API_CHECKS ]; do
    if curl -s -k -m 10 https://schoolactive.ru/api/auth/me > /dev/null 2>&1; then
        log "‚úÖ HTTPS API –æ—Ç–≤–µ—á–∞–µ—Ç"
        break
    else
        API_CHECK_COUNT=$((API_CHECK_COUNT + 1))
        if [ $API_CHECK_COUNT -lt $MAX_API_CHECKS ]; then
            warn "‚è≥ API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –ø–æ–ø—ã—Ç–∫–∞ $API_CHECK_COUNT/$MAX_API_CHECKS, –∂–¥—É 10 —Å–µ–∫—É–Ω–¥..."
            sleep 10
        else
            error "‚ùå HTTPS API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ $MAX_API_CHECKS –ø–æ–ø—ã—Ç–æ–∫"
            exit 1
        fi
    fi
done

# –ü—Ä–æ–≤–µ—Ä–∫–∞ frontend
log "üñ•Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ frontend..."
if curl -s -k -m 10 https://schoolactive.ru > /dev/null 2>&1; then
    log "‚úÖ Frontend –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    warn "‚ö†Ô∏è Frontend –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

# ========================
# –ó–ê–í–ï–†–®–ï–ù–ò–ï –ò –û–¢–ß–ï–¢
# ========================

log "üéâ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"

# –û—Ç—á–µ—Ç –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
echo ""
info "üìä –û–¢–ß–ï–¢ –û–ë –û–ë–ù–û–í–õ–ï–ù–ò–ò:"
info "üïê –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: $(date)"
info "üíæ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏: $BACKUP_DIR"
info "üåê –°–∞–π—Ç: https://schoolactive.ru"
info "üîß API: https://schoolactive.ru/api/"

echo ""
info "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
pm2 list

echo ""
info "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ API:"
pm2 logs projectx-api --lines 10

echo ""
info "üíæ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏:"
ls -la "$BACKUP_DIR" | grep "$BACKUP_DATE" || echo "–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ —Å –¥–∞—Ç–æ–π $BACKUP_DATE"

echo ""
log "‚úÖ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ HTTPS —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç!"
log "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!"
log "‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö!"

echo ""
warn "üìù –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:"
warn "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Å–∞–π—Ç–∞ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä"
warn "2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—Ö–æ–¥–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
warn "3. –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π"
warn "4. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: pm2 logs projectx-api"

# –û—Ç–∫–ª—é—á–∞–µ–º trap –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
trap - ERR

log "üèÅ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ."
